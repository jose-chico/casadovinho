<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pagamento | Casa de Vinho</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://kit.fontawesome.com/9e62b207e5.js" crossorigin="anonymous"></script>
  <style>
    .metodo-box {
      background: var(--bg-surface-alt);
      border-radius: 8px;
      padding: 16px;
      margin-top: 12px;
      text-align: center;
      display: none;
    }
    .qr-code {
      margin: 16px auto;
      display: block;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      max-width: 200px;
    }
    .input-cartao {
      display: grid;
      gap: 8px;
      margin-top: 12px;
      text-align: left;
    }
    .input-cartao input {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--bg-surface);
      color: var(--text-main);
      font-size: .85rem;
    }
    .codigo-boleto {
      background: var(--bg-surface);
      border: 1px dashed var(--accent-contrast);
      padding: 12px;
      font-family: monospace;
      border-radius: 6px;
      font-size: .8rem;
      margin: 12px 0;
      word-break: break-all;
    }

    /* üîÑ LOADER DE PAGAMENTO */
    .loader-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: var(--accent-contrast);
      font-weight: 600;
      font-size: 1rem;
      z-index: 6000;
      gap: 16px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .loader-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    .loader-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(255,255,255,0.2);
      border-top-color: var(--accent-contrast);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div class="frete-bar">
    <span>üöö Frete gr√°tis acima de R$ 199,00 Brasil inteiro</span>
  </div>

  <header class="topo checkout-topo">
    <a class="logo" href="index.html">üç∑ Casa de Vinho</a>
  </header>

  <main class="checkout-page page-wrapper">
    <section class="checkout-card">
      <h1>Pagamento</h1>

      <div id="resumo-pedido" class="checkout-lista"></div>

      <h3 style="color: var(--accent-contrast); margin-top: 16px;">Selecione o m√©todo de pagamento</h3>
      <div class="checkout-lista" style="text-align: left;">
        <label><input type="radio" name="metodo" value="pix" checked> üí† Pix (5% de desconto)</label>
        <label><input type="radio" name="metodo" value="cartao"> üí≥ Cart√£o de Cr√©dito</label>
        <label><input type="radio" name="metodo" value="boleto"> üßæ Boleto Banc√°rio</label>
      </div>

      <div id="area-metodo" class="metodo-box"></div>

      <button id="btn-pagar" class="checkout-btn-big">Pagar Agora</button>

      <p id="msg-pagamento" class="checkout-msg"></p>
    </section>
  </main>

  <footer class="footer">
    <p>¬© 2025 Casa de Vinho üçá</p>
  </footer>

  <!-- üîÑ Tela de carregamento -->
  <div id="loader" class="loader-overlay">
    <div class="loader-spinner"></div>
    <p>Processando pagamento...</p>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const resumo = document.getElementById("resumo-pedido");
      const msg = document.getElementById("msg-pagamento");
      const btn = document.getElementById("btn-pagar");
      const areaMetodo = document.getElementById("area-metodo");
      const radios = document.querySelectorAll('input[name="metodo"]');
      const loader = document.getElementById("loader");

      const itens = JSON.parse(localStorage.getItem("pedidoItens")) || [];
      const total = localStorage.getItem("pedidoTotal") || "R$ 0,00";

      if (!itens.length) {
        resumo.innerHTML = "<p style='color: var(--text-muted)'>Nenhum pedido encontrado.</p>";
        return;
      }

      let html = "";
      itens.forEach(item => {
        html += `<div class="checkout-item">
          <div class="item-nome">${item.qtd}x ${item.nome}</div>
          <div class="item-preco">${item.preco.toLocaleString("pt-BR", {style: "currency", currency: "BRL"})} cada</div>
        </div>`;
      });
      html += `<p class="checkout-total">Total a pagar: <strong>${total}</strong></p>`;
      resumo.innerHTML = html;

      function mostrarMetodo(tipo) {
        areaMetodo.style.display = "block";
        msg.textContent = "";
        if (tipo === "pix") {
          const codigoPix = "00020126580014BR.GOV.BCB.PIX0136pagamento@casadevinho.com.br5204000053039865802BR5925Casa de Vinho LTDA6009Sao Paulo62070503***6304A1B2";
          areaMetodo.innerHTML = `
            <p>Escaneie o QR Code abaixo para pagar:</p>
            <img class="qr-code" src="https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(codigoPix)}&size=200x200" alt="QR Code Pix">
            <p style="font-size:.8rem;color:var(--text-muted)">C√≥digo Pix:</p>
            <div class="codigo-boleto">${codigoPix}</div>
          `;
        } 
        else if (tipo === "cartao") {
          areaMetodo.innerHTML = `
            <div class="input-cartao">
              <input type="text" placeholder="Nome no cart√£o">
              <input type="text" placeholder="N√∫mero do cart√£o (16 d√≠gitos)" maxlength="19">
              <div style="display:flex;gap:8px;">
                <input type="text" placeholder="Validade (MM/AA)" maxlength="5">
                <input type="text" placeholder="CVV" maxlength="3">
              </div>
            </div>
          `;
        } 
        else if (tipo === "boleto") {
          const codigo = "34191.79001 01043.510047 91020.150008 9 94870000015000";
          areaMetodo.innerHTML = `
            <p>Seu boleto foi gerado com vencimento em <strong>3 dias √∫teis</strong>.</p>
            <div class="codigo-boleto">${codigo}</div>
            <p style="font-size:.8rem;color:var(--text-muted)">Use este c√≥digo para pagar no banco ou internet banking.</p>
          `;
        }
      }

      mostrarMetodo("pix");
      radios.forEach(r => r.addEventListener("change", e => mostrarMetodo(e.target.value)));

      btn.addEventListener("click", () => {
        const metodo = document.querySelector('input[name="metodo"]:checked').value;

        // üîÑ Mostra o loader
        loader.classList.add("active");

        // Simula o tempo de processamento
        setTimeout(() => {
          loader.classList.remove("active");
          msg.textContent = `Pagamento via ${metodo.toUpperCase()} confirmado! üç∑ Obrigado pela compra.`;
          msg.style.color = "var(--success)";
          areaMetodo.style.display = "none";

          localStorage.removeItem("pedidoItens");
          localStorage.removeItem("pedidoTotal");
          localStorage.removeItem("carrinho");

          // Redireciona ap√≥s 2s
          setTimeout(() => window.location.href = "index.html", 2000);
        }, 2500);
      });
    });
  </script>

</body>
<script>
  const user = JSON.parse(localStorage.getItem("usuarioLogado"));
  if (!user) {
    alert("Voc√™ precisa estar logado para finalizar a compra.");
    window.location.href = "login.html";
  }
</script>

</html>

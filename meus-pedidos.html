<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meus Pedidos | Casa de Vinho</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://kit.fontawesome.com/9e62b207e5.js" crossorigin="anonymous"></script>
  <style>
    /* Toast visual de confirmação */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--accent-contrast);
      color: #000;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      box-shadow: 0 0 12px rgba(0,0,0,0.3);
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 9999;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>

  <!-- BARRA DE FRETE GRÁTIS -->
  <div class="frete-bar">
    <span>🚚 Frete grátis acima de R$ 199,00 Brasil inteiro</span>
  </div>

  <!-- HEADER -->
  <header class="topo checkout-topo">
    <a class="logo" href="index.html">🍷 Casa de Vinho</a>

    <div class="topo-right">
      <button id="theme-toggle" class="theme-toggle" title="Trocar tema">
        <i class="fa-solid fa-circle-half-stroke"></i>
      </button>

      <!-- Botão de sair -->
      <button id="btn-logout" class="btn-cart" style="display:none;">
        <i class="fa-solid fa-right-from-bracket"></i>
        <span class="cart-text">Sair</span>
      </button>
    </div>
  </header>

  <!-- CONTEÚDO -->
  <main class="page-wrapper" style="max-width:800px; margin:auto; padding:40px 20px;">
    <h1 style="text-align:center; margin-bottom:30px;">📦 Meus Pedidos</h1>

    <div id="lista-pedidos" style="display:grid; gap:20px;"></div>

    <div id="acoes-pedidos" style="text-align:center; margin-top:40px; display:none;">
      <button id="btn-esvaziar" class="checkout-btn" style="background:#a4161a;">
        Esvaziar Meus Pedidos
      </button>
      <a href="index.html" class="checkout-btn" style="margin-left:10px;">Voltar à loja</a>
    </div>
  </main>

  <footer class="footer">
    <p>© 2025 Casa de Vinho · Brinde aos bons momentos 🍇</p>
  </footer>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const btnLogout = document.getElementById("btn-logout");
      const lista = document.getElementById("lista-pedidos");
      const btnEsvaziar = document.getElementById("btn-esvaziar");
      const acoes = document.getElementById("acoes-pedidos");
      const toast = document.getElementById("toast");

      const user = JSON.parse(localStorage.getItem("usuarioLogado"));
      const pedidosLS = JSON.parse(localStorage.getItem("pedidos")) || [];

      // Mostrar botão Sair se logado
      if (btnLogout && user) {
        btnLogout.style.display = "flex";
        btnLogout.addEventListener("click", () => {
          if (confirm(`Deseja sair da conta de ${user.nome}?`)) {
            localStorage.removeItem("usuarioLogado");
            alert("Você saiu da sua conta 🍷");
            window.location.href = "index.html";
          }
        });
      }

      // Toast helper
      function mostrarToast(mensagem, cor = "#79d70f") {
        toast.textContent = mensagem;
        toast.style.background = cor;
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
        }, 2500);
      }

      // Filtra apenas pedidos desse usuário
      const meusPedidos = user
        ? pedidosLS.filter(p => p.usuario === user.email)
        : [];

      if (!meusPedidos.length) {
        lista.innerHTML = "<p style='text-align:center;color:var(--muted)'>Você ainda não fez nenhum pedido 🍷</p>";
        return;
      }

      // Temos pedidos -> mostra os botões "esvaziar / voltar"
      acoes.style.display = "block";

      // Renderiza pedidos (do mais novo pro mais antigo)
      [...meusPedidos].reverse().forEach((pedido) => {
        // garante que sempre vamos ter um idPedido
        const idPedido = pedido.idPedido || new Date(pedido.data).getTime();

        const card = document.createElement("div");
        card.style.background = "var(--card-bg)";
        card.style.padding = "24px";
        card.style.borderRadius = "12px";
        card.style.boxShadow = "0 0 15px rgba(0,0,0,0.3)";
        card.style.color = "var(--text)";
        card.setAttribute("data-idpedido", idPedido);

        let html = `
          <h3 style="color:var(--accent);margin-bottom:10px;">
            Pedido #${idPedido}
          </h3>

          <p><strong>Data:</strong> ${pedido.data}</p>
          <p><strong>Método de pagamento:</strong> ${pedido.metodo.toUpperCase()}</p>
          <p><strong>Total:</strong> ${pedido.total}</p>

          <hr style="margin:10px 0;border-color:rgba(255,255,255,0.1);">

          <h4 style="margin-bottom:8px;">Itens:</h4>
        `;

        pedido.itens.forEach(item => {
          html += `<p>${item.qtd}x ${item.nome} - R$ ${item.preco.toFixed(2)}</p>`;
        });

        html += `
          <div style="text-align:right; margin-top:16px;">
            <button class="checkout-btn btn-deletar" style="background:#ba181b;font-size:.85rem;">
              <i class="fa-solid fa-trash"></i> Excluir Pedido
            </button>
          </div>
        `;

        card.innerHTML = html;
        lista.appendChild(card);
      });

      // Atualiza localStorage depois de deletar, e dá feedback
      function atualizarPedidos(novosPedidos, mensagemToast) {
        localStorage.setItem("pedidos", JSON.stringify(novosPedidos));
        mostrarToast(mensagemToast);

        // Espera o toast aparecer e some, e aí atualiza a página
        setTimeout(() => {
          window.location.reload();
        }, 1200);
      }

      // Clicar em "Excluir Pedido" (um só)
      document.querySelectorAll(".btn-deletar").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const card = e.target.closest("[data-idpedido]");
          const idApagar = card.getAttribute("data-idpedido");

          if (!confirm("Deseja realmente excluir este pedido?")) return;

          // Mantém todos MENOS o que tem esse idPedido
          const novosPedidos = pedidosLS.filter(p => {
            const idP = p.idPedido || new Date(p.data).getTime().toString();
            return !(p.usuario === user.email && idP === idApagar);
          });

          atualizarPedidos(novosPedidos, "🗑️ Pedido removido com sucesso!");
        });
      });

      // Clicar em "Esvaziar Meus Pedidos" (todos)
      btnEsvaziar.addEventListener("click", () => {
        if (!confirm("Tem certeza que deseja apagar todos os seus pedidos?")) return;

        const restantes = pedidosLS.filter(p => p.usuario !== user.email);

        atualizarPedidos(restantes, "🧹 Todos os pedidos foram apagados!");
      });
    });
  </script>
</body>
</html>

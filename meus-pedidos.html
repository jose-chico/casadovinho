<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meus Pedidos | Casa de Vinho</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://kit.fontawesome.com/9e62b207e5.js" crossorigin="anonymous"></script>
  <style>
    /* 🍷 Toast elegante com barra dourada */
    .toast {
      position: fixed;
      top: 25px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: rgba(40, 20, 20, 0.95);
      color: #fff;
      border: 1px solid #d4aa00;
      border-radius: 10px;
      padding: 14px 22px 10px;
      font-size: 0.95rem;
      font-weight: 500;
      box-shadow: 0 4px 18px rgba(0, 0, 0, 0.6);
      opacity: 0;
      pointer-events: none;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-direction: column;
      transition: all 0.4s ease;
      z-index: 9999;
      width: fit-content;
      min-width: 260px;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
    }
    .toast i {
      font-size: 1rem;
    }
    .toast-text {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Barra dourada animada */
    .toast-progress {
      position: relative;
      width: 100%;
      height: 4px;
      background: rgba(212, 170, 0, 0.2);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 6px;
    }
    .toast-progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: #d4aa00;
      width: 100%;
      transform-origin: left;
      animation: progressBar 2.5s linear forwards;
    }
    @keyframes progressBar {
      from { width: 100%; }
      to { width: 0%; }
    }

    /* Tipos de toast */
    .toast.sucesso { border-color: #79d70f; }
    .toast.erro { border-color: #d9534f; }
    .toast.info { border-color: #d4aa00; }

    .toast.sucesso i { color: #79d70f; }
    .toast.erro i { color: #d9534f; }
    .toast.info i { color: #d4aa00; }

    /* Botões refinados */
    .btn-danger {
      background:#a4161a;
      color:#fff;
      border:none;
      border-radius:8px;
      padding:10px 16px;
      font-size:.9rem;
      font-weight:600;
      cursor:pointer;
      transition: 0.2s;
    }
    .btn-danger:hover {
      filter:brightness(1.1);
      transform: scale(1.03);
    }

    .btn-warning {
      background:#d4aa00;
      color:#000;
      border:none;
      border-radius:8px;
      padding:10px 16px;
      font-size:.9rem;
      font-weight:600;
      cursor:pointer;
      transition: 0.2s;
      text-decoration:none;
      display:inline-block;
    }
    .btn-warning:hover {
      filter:brightness(1.1);
      transform: scale(1.03);
    }

    .pedido-card {
      background: var(--card-bg, #111);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      color: var(--text, #fff);
      border: 1px solid rgba(255,255,255,0.05);
    }

    .pedido-head {
      color: #e0b000;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .pedido-info p {
      margin: 6px 0;
      font-size: .95rem;
      line-height: 1.4;
    }

    .pedido-info hr {
      margin: 16px 0;
      border: 0;
      border-top: 1px solid rgba(255,255,255,0.15);
    }

    .pedido-itens p {
      margin: 4px 0;
      font-size: .95rem;
    }

    .pedido-footer {
      text-align: right;
      margin-top: 16px;
    }

    .acoes-wrapper {
      text-align:center;
      margin-top:40px;
      display:none;
    }
    .acoes-wrapper > *:not(:last-child){
      margin-right:10px;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="topo checkout-topo">
    <a class="logo" href="index.html">🍷 Casa de Vinho</a>

    <div class="topo-right">
      <button id="theme-toggle" class="theme-toggle" title="Trocar tema">
        <i class="fa-solid fa-circle-half-stroke"></i>
      </button>

      <button id="btn-logout" class="btn-cart" style="display:none;">
        <i class="fa-solid fa-right-from-bracket"></i>
        <span class="cart-text">Sair</span>
      </button>
    </div>
  </header>

  <main class="page-wrapper" style="max-width:800px; margin:auto; padding:40px 20px;">
    <h1 style="text-align:center; margin-bottom:30px;">📦 Meus Pedidos</h1>
    <div id="lista-pedidos" style="display:grid; gap:20px;"></div>

    <div id="acoes-pedidos" class="acoes-wrapper">
      <button id="btn-esvaziar" class="btn-danger">Esvaziar Meus Pedidos</button>
      <a href="index.html" id="btn-voltar" class="btn-warning">Voltar à loja</a>
    </div>
  </main>

  <footer class="footer">
    <p>© 2025 Casa de Vinho · Brinde aos bons momentos 🍇</p>
  </footer>

  <!-- Toast -->
  <div id="toast" class="toast info">
    <div class="toast-text"><i class="fa-solid fa-wine-glass"></i><span></span></div>
    <div class="toast-progress"><div class="toast-progress-bar"></div></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const btnLogout = document.getElementById("btn-logout");
      const lista = document.getElementById("lista-pedidos");
      const btnEsvaziar = document.getElementById("btn-esvaziar");
      const btnVoltar = document.getElementById("btn-voltar");
      const acoes = document.getElementById("acoes-pedidos");
      const toast = document.getElementById("toast");
      const toastMsg = toast.querySelector("span");

      const user = JSON.parse(localStorage.getItem("usuarioLogado"));
      const pedidosLS = JSON.parse(localStorage.getItem("pedidos")) || [];

      // 🍾 Função de toast aprimorada
      function mostrarToast(mensagem, tipo = "info") {
        toast.className = `toast ${tipo}`;
        let icone = "fa-wine-glass";
        if (tipo === "sucesso") icone = "fa-check-circle";
        if (tipo === "erro") icone = "fa-circle-xmark";
        toast.querySelector("i").className = `fa-solid ${icone}`;
        toastMsg.textContent = mensagem;
        toast.classList.add("show");

        const barra = toast.querySelector(".toast-progress-bar");
        barra.style.animation = "none";
        void barra.offsetWidth;
        barra.style.animation = "progressBar 2.5s linear forwards";

        setTimeout(() => toast.classList.remove("show"), 2500);
      }

      // Mostrar botão sair se logado
      if (btnLogout && user) {
        btnLogout.style.display = "flex";
        btnLogout.addEventListener("click", () => {
          localStorage.removeItem("usuarioLogado");
          mostrarToast("Você saiu da sua conta 🍷", "info");
          setTimeout(() => window.location.href = "index.html", 1500);
        });
      }

      // Filtrar pedidos do usuário
      const meusPedidosMapeados = [];
      pedidosLS.forEach((pedido, indexGlobal) => {
        if (user && pedido.usuario === user.email) {
          meusPedidosMapeados.push({ indexGlobal, pedido });
        }
      });

      if (!meusPedidosMapeados.length) {
        lista.innerHTML = "<p style='text-align:center;color:var(--muted)'>Você ainda não fez nenhum pedido 🍷</p>";
        return;
      }

      acoes.style.display = "block";

      // Renderizar pedidos
      [...meusPedidosMapeados].reverse().forEach(entrada => {
        const { indexGlobal, pedido } = entrada;
        const idPedido = pedido.idPedido ? `#${pedido.idPedido}` : `#${indexGlobal + 1}`;
        const card = document.createElement("div");
        card.className = "pedido-card";
        card.setAttribute("data-index-global", indexGlobal);

        let html = `
          <div class="pedido-head">Pedido ${idPedido}</div>
          <div class="pedido-info">
            <p><strong>Data:</strong> ${pedido.data}</p>
            <p><strong>Método de pagamento:</strong> ${pedido.metodo.toUpperCase()}</p>
            <p><strong>Total:</strong> ${pedido.total}</p>
            <hr>
            <p><strong>Itens:</strong></p>
          </div>
          <div class="pedido-itens">
        `;
        pedido.itens.forEach(item => {
          html += `<p>${item.qtd}× ${item.nome} - R$ ${item.preco.toFixed(2)}</p>`;
        });
        html += `
          </div>
          <div class="pedido-footer">
            <button class="btn-danger btn-deletar">
              <i class="fa-solid fa-trash"></i> Excluir Pedido
            </button>
          </div>
        `;
        card.innerHTML = html;
        lista.appendChild(card);
      });

      // Atualizar pedidos e exibir toast
      function atualizarPedidos(novosPedidos, mensagem, tipo="sucesso") {
        localStorage.setItem("pedidos", JSON.stringify(novosPedidos));
        mostrarToast(mensagem, tipo);
        setTimeout(() => window.location.reload(), 1200);
      }

      // Excluir pedido
      document.querySelectorAll(".btn-deletar").forEach(btn => {
        btn.addEventListener("click", e => {
          const card = e.target.closest("[data-index-global]");
          const indexGlobal = card.getAttribute("data-index-global");
          const novos = [...pedidosLS];
          novos.splice(Number(indexGlobal), 1);
          atualizarPedidos(novos, "🗑️ Pedido removido com sucesso!", "sucesso");
        });
      });

      // Esvaziar tudo
      btnEsvaziar.addEventListener("click", e => {
        e.preventDefault();
        const restantes = pedidosLS.filter(p => !(user && p.usuario === user.email));
        atualizarPedidos(restantes, "🧹 Todos os pedidos foram apagados!", "sucesso");
      });

      // Voltar à loja
      btnVoltar.addEventListener("click", e => {
        e.preventDefault();
        mostrarToast("Voltando à loja...", "info");
        setTimeout(() => window.location.href = "index.html", 1000);
      });
    });
  </script>
</body>
</html>
